---
output: 
  html_document:
    toc: true
    toc_float: true
params: 
  title: NULL
  description: NULL
  remarks: NULL
  w_full: ""
  w_hist: ""
  w_comp: ""
  w_perc: ""
  w_dates: ""
  report_dates: ""
  n_days: ""
  years_min: ""
title: "`r if(!is.null(params$title)) params$title else 'Observation Wells Groundwater Levels'`"
---

```{css, echo=FALSE}
h2 {
  padding-top: 0.2em;
  padding-left: 0.2em;
  margin-top: 30px;
  background-color: #337ab7;
    border-top: 2px solid grey;
  color: white;
}

h3 {
  margin-top: 35px;
}

body {
  font-size: 12pt
}

.leaflet {
  margin: auto;
}

.bcgwl-table {
  color: black;
  border-top: 2px solid black;
  border-bottom: 2px solid black;
}

.bcgwl-table th {
  padding-top: 7px;
}

.bcgwl-table td {
  padding-top: 5px;
  padding-bottom: 3px;
}

.lightable-classic tfoot tr:first-child td {
  border-top: 2px solid black;
}
```



```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(gt)
library(glue)
library(lubridate)
library(stringr)
library(patchwork)

knitr::opts_chunk$set(echo = FALSE)
options(knitr.kable.NA = '')

w_full <- params$w_full
w_hist <- params$w_hist
w_comp <- params$w_comp
w_perc <- params$w_perc
w_dates <- params$w_dates
n_days <- params$n_days
report_dates <- params$report_dates
years_min <- params$years_min

ows <- unique(w_full$ow)

window <- w_perc %>%
  filter(window) %>%
  pull(report_dates) %>%
  unique()

range1 <- length(report_dates)/2
range2 <- (range1 + 1):(range1 * 2)
range1 <- 1:range1

remarks <- tibble(ow = NA, remarks = NA, .rows = 0)
if(!is.null(params$remarks)) remarks <- params$remarks
```


```{r description, results = "asis"}
if(!is.null(params$description) && params$description != "") {
  cat(params$description)
}
```

This report was generated on `r format(Sys.Date(), "%B %d, %Y")`.

## Background {#background}

<details>
  <summary>Show</summary>

The province maintains a network of groundwater observation wells to monitor water levels in priority aquifers. These observation wells (OW) record water level fluctuations which allow for improved understanding of how aquifers respond to changes in climate, precipitation, and effects from pumping. Many of the observation wells are equipped with satellite telemetry to provide real time information on water levels.

The following summaries compare recent groundwater levels to historical continuous daily records to determine percentile classes, with a minimum of `r years_min` years of data. A percentile is on a scale of 100 and indicates the percent of a distribution that is equal to or below it. For example, a groundwater level at the 10th percentile is equal to or greater than 10% of the water level values recorded on this day of the year during all years of data.

In general, a groundwater level value that is:

* the highest ever measured for the day of year is considered 
  <span style="color: `r perc_values$colour[1]`;">**High**</span>
* greater than the 90th percentile is considered 
  <span style="color: `r perc_values$colour[2]`;">**Much Above Normal**</span>
* between 75th percentile and 90th percentile is considered 
  <span style="color: `r perc_values$colour[3]`;">**Above Normal**</span>
* between 25th and 75th percentiles is considered 
  <span style="color: `r perc_values$colour[4]`;">**Normal**</span>
* less than the 25 percentile is considered 
  <span style="color: `r perc_values$colour[5]`;">**Below Normal**</span>
* less than 10 percentile is considered 
  <span style="color: `r perc_values$colour[6]`;">**Much Below Normal**</span>
* the lowest ever measured for the day of year is considered
  <span style="color: `r perc_values$colour[7]`;">**Low**</span>.

</details>

## Groundwater Levels Map {#map}

```{r wells_map}
details <- well_table_summary(w_dates, w_hist, perc_values)
well_map(details)
```

**Notes:**

`r emo::ji("fish")` = Likely hydraulically connected


## Wells Below Normal {#wells-below-normal .tabset}

### **Description**

This section reports on the number and total proportion of wells below normal or lower (i.e. 25th percentile or lower) on a given reporting date and one year prior for comparison.

### All Wells


```{r wells_below_normal_overall}
t <- well_table_below_norm(w_perc, window, which = "totals")

# Get footnotes needed
missing_dates <- str_subset(names(t), "\\*") %>% str_remove("\\*")
missing_data <- any(t == "" | is.na(t))
t %>%
  rename_with(~str_remove(., "\\*")) %>%
  gt() %>%
  gt_bcgwl_style() %>%
  tab_spanner(label = "Current Year", columns = !!range1) %>%
  tab_spanner(label = "Last Year", columns = !!range2) %>%
  footnotes_below_normal(missing_dates, missing_data, n_days = n_days)
```


### By Percentile Classes

```{r percentile_class}
t <- well_table_status(w_perc, perc_values, window)

# Get footnotes needed
missing_dates <- str_subset(names(t), "\\*") %>% str_remove("\\*")
missing_data <- any(t == "" | is.na(t))

t %>%
  rename_with(~str_remove(., "\\*")) %>%
  gt(rowname_col = "class") %>%
  gt_bcgwl_style() %>%
  gt_perc_colours(perc_col = "stub") %>%
  cols_align("center") %>%
  tab_spanner(label = "Current Year", columns = 1 + !!range1) %>%
  tab_spanner(label = "Last Year", columns = 1 + !!range2) %>%
  footnotes_below_normal(missing_dates, missing_data, n_days = n_days)
```


### By Hydraulic Connectivity

```{r wells_below_normal_type}
t <- well_table_below_norm(w_perc, window, which = "hydraulic_connectivity")

# Get footnotes needed
missing_dates <- str_subset(names(t), "\\*") %>% str_remove("\\*")
missing_data <- any(t == "" | is.na(t))

t %>%
  rename_with(~str_remove(., "\\*")) %>%
  gt() %>%
  gt_bcgwl_style() %>%
  tab_spanner(label = "Current Year", columns = 1 + (1:rd)) %>%
  tab_spanner(label = "Last Year", columns = 1 + ((rd + 1):(rd * 2))) %>%
  footnotes_below_normal(missing_dates, missing_data, n_days = n_days)
```



### By Aquifer Type


```{r wells_below_normal_connectivity}
t <- well_table_below_norm(w_perc, window, which = "type")

# Get footnotes needed
missing_dates <- str_subset(names(t), "\\*") %>% str_remove("\\*")
missing_data <- any(t == "" | is.na(t))

t %>%
  rename_with(~str_remove(., "\\*")) %>%
  gt() %>%
  gt_bcgwl_style() %>%
  tab_spanner(label = "Current Year", columns = 1 + (1:rd)) %>%
  tab_spanner(label = "Last Year", columns = 1 + ((rd + 1):(rd * 2))) %>%
  footnotes_below_normal(missing_dates, missing_data, n_days = n_days)
```


## Observation Well Latest Details {#details}

<details>
  <summary>Show</summary>

**Latest details on observation wells in `r year(details[["Latest\nDate"]][1])`**

```{r well_summaries}
foot1 <- "n is the number of years included in the percentile calculation."
foot2 <- "Values with an Approval Status of ‘Working’"

groups <- c("region", "area")
if(length(unique(details$region)) == 1) groups <- c("area")

details %>%
  mutate(percentile = if_else(
    !is.na(percentile), 
    glue("{class} ({percentile}%)<br><small>(n = {n_years})</small>"),
    glue("(n = {n_years})")),
    percentile = purrr::map(percentile, html)) %>%
  select(region, area, location, ow, hydraulic_connectivity, 
         aquifer_type, date, percentile, class, approval) %>%
  left_join(remarks, by = "ow") %>%
  group_by(across(all_of(groups))) %>%
  gt() %>%
  gt_bcgwl_style() %>%
  cols_hide(c("approval", "class")) %>%
  cols_label("location" = "Location",
             "hydraulic_connectivity" = "Hydraulic Connection", 
             "aquifer_type" = "Aquifer Type",
             "date" = "Latest Date" , 
             "percentile" = "Percentile",
             "ow" = "Obs. Well", 
             "remarks" = "Remarks") %>%
  gt_perc_colours() %>%
  fmt_missing(everything(), missing_text = "") %>%
  tab_footnote(foot1, locations = cells_column_labels("percentile")) %>%
  tab_footnote(foot2, locations = cells_body(columns = "date", 
                                             rows = approval == "Working")) %>%
  opt_footnote_marks(marks = c("a", "\u2731")) %>%
  text_transform(locations = cells_body(columns = "ow"),
                 fn = function(x) ow_fish(x) %>% ow_link(format = "html")) %>%
  cols_align("left", columns = "remarks")
```


</details>


## Historical Water Level Plots {#plots .tabset} 

### **Description**

Annual hydrographs and historical records for the observation wells summarized above can be found in this section.

Current conditions for provincial groundwater observation wells can be accessed any time through the [Groundwater Level Data Interactive Map]( https://www2.gov.bc.ca/gov/content/environment/air-land-water/water/groundwater-wells-aquifers/groundwater-observation-well-network/groundwater-level-data-interactive-map).

Note: ‘Working’ data are preliminary and have not yet been finalized as ‘Approved’ data with approved corrections and data grades for quality assurance. Quality assurance procedures may result in differences between what is displayed as 'Working' and what will become the official record.

```{r plots, results = "asis", fig.asp = 0.9, fig.width = 10}
latest_date <- w_dates %>% 
  group_by(ow) %>% 
  filter(!is.na(Value)) %>%
  filter(Date == max(Date)) %>%
  filter(CurrentYear) #Keep only ones that are in Table 4?

w_meta <- w_dates %>%
  well_meta()
for(ow in sort(ows)) {
  w_meta %>%
    filter(.data$ow %in% !!ow) %>%
    select("ow", "region", "location", "type", "hydraulic_connectivity") %>%
    distinct() %>%
    mutate(ow = ow_fish(ow)) %>%
    glue_data("\n\n\n### {ow}\n\n",
              "[Map](#map)<br>",
              "<strong>Region:</strong> {region}<br>\n",
              "<strong>Location:</strong> {location}<br>\n",
              "<strong>Aquifer type:</strong> {type}<br>\n",
              "<strong>Hydraulic_connectivity:</strong> ",
              "{hydraulic_connectivity}<p>\n\n") %>%
    cat()
  full <- filter(w_full, ow == !!ow)
  hist <- filter(w_hist, ow == !!ow)
  date <- filter(latest_date, ow == !!ow)
  
  g1 <- well_plot_perc(full, hist, date, years_min)
  g2 <- well_plot_hist(full, hist)
  
  g <- g1 / g2
  print(g)
}
```


## Appendices {#appendices .tabset}

### A - Dates

If data isn't available for an exact reporting date, dates up to `r n_days` days
before and `r n_days` days after the report date are examined for non-missing data. 
Thus, an alternative date is chosen within a 
`r n_days * 2 + 1`-day window, centred on the reporting date.

If there are multiple dates with data, the dates are ranked based on their historical data
quality (for calculating percentiles) and their nearness to the original date indicated.
The top date is then chosen for that well and that reporting date. 

This table lists the original reporting dates, and the actual dates used for each 
observation well. 

```{r appendix}
a <- appendix_dates(w_dates)
index <- table(a$region)

tbl_a <- a %>%
  select(- "region") %>%
  kable(format = "html", align = "llccccc", escape = FALSE) %>%
  kable_styling(
    bootstrap_options = "hover", full_width = FALSE, 
    htmltable_class = "bcgwl-table lightable-classic lightable-hover") %>%
  row_spec(0, bold = TRUE) %>%
  add_header_above(c("", "", "", "Report Dates vs. Measurement dates" = 4), 
                   bold = TRUE)

#if(any(a == ""  | is.na(a))) tbl_a <- kableExtra::footnote(tbl_a, general = glue("<span class = 'footnote'>&bull; {note_no_data}</span>"), escape = FALSE)

tbl_a

```


### B - Calculations

#### General details
- Water year starts in October
- Well measurements are all in Depth Below Ground in metres
- Current Water Year plots show data for the most recent water year with at least
  1 week of data (7 days).

#### Percentiles
- Percentiles are calculated individually for each day of the year for each well
- 366 day in leap years is omitted
- "Good" quality data have 'Approved' historical values for >= `r years_min` years
- "Poor" quality data have 'Approved' historical values for < `r years_min` 
  years and are not used (percentiles for that well on that day of the year are
  missing from the figures and tables).


### C - Run info

#### Parameters

- **Observation Wells** (`ows`): `r glue_collapse(ows, ", ")`
- **Report Dates** (`report_dates`): `r glue_collapse(report_dates[1:2], ", ")`
- **No. Days on either side of report date in which search for alternate date** (`n_days`): `r n_days`
  - Total window around (and including) a reporting date is **`r n_days * 2 + 1` days**
- **Percentile Calculations**
  - **Min number of years** (`years_min`) - `r years_min`

#### Session Info

**Platform**

```{r}
sessioninfo::platform_info()
```

**Packages**
```{r}
sessioninfo::package_info()
```

