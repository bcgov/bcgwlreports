---
title: "Observation Wells Groundwater Levels"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
params: 
  w_full: ""
  w_hist: ""
  w_comp: ""
  w_perc: ""
  w_dates: ""
  report_dates: ""
  within: ""
  years_min: ""
---

```{css, echo=FALSE}
h2 {
  border-top: 2px solid;
  padding-top: 10px;
  margin-top: 30px;
}

.lightable-classic td {
  padding-top: 5px;
  padding-bottom: 5px;
}

body {
  font-size: 12pt
}
```



```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(kableExtra)
library(glue)
library(lubridate)
library(stringr)
library(patchwork)

knitr::opts_chunk$set(echo = FALSE)
options(knitr.kable.NA = '')

w_full <- params$w_full
w_hist <- params$w_hist
w_comp <- params$w_comp
w_perc <- params$w_perc
w_dates <- params$w_dates
within <- params$within
report_dates <- params$report_dates
years_min <- params$years_min

ows <- unique(w_full$ow)

window <- w_perc %>%
  filter(window) %>%
  pull(report_dates) %>%
  unique()

note_value <- glue("value within a {within*2 + 1}-day window centred on the reporting date")
note_values <- glue("includes values from a {within*2 + 1}-day window centred on the reporting date")
note_no_data <- "Blank cells indicate no data"
```

## Wells below normal

```{r wells_below_normal_prep}
p <- well_table_below_norm(w_perc, window)
```


```{r wells_below_normal_overall}
p %>%
  filter(`Aquifer Type` == "Across all types") %>%
  select(-"Aquifer Type") %>%
  kable(format = "html", caption = "<center><strong>Overall</strong></center>",
        align = "cccc") %>%
  bcgwl_style() %>%
  add_header_above(c("Current Year" = 2, "Last Year" = 2))
```

```{r wells_below_normal_type}
p %>%
  filter(`Aquifer Type` != "Across all types") %>%
  rename(" " = `Aquifer Type`) %>%
  kable(format = "html", caption = "<center><strong>Aquifer Type</strong></center>",
        align = "lcccc") %>%
  bcgwl_style() %>%
  add_header_above(c("", "Current Year" = 2, "Last Year" = 2))
```


```{r wells_below_normal_connectivity}
p %>%
  filter(`Aquifer Type` != "Across all types") %>%
  rename(" " = `Aquifer Type`) %>%
  kable(format = "html", align = "lcccc",
        caption = "<center><strong>Hydraulic Connectivity</strong></center>") %>%
  bcgwl_style() %>%
  add_header_above(c("", "Current Year" = 2, "Last Year" = 2))
```



*Note:*  
(X/Y) indicates X wells with low values out of Y wells total for that date/category  
`r note_no_data`  
* `r note_values`

### Groundwater Level Status

**Number of wells in each percentile class by date**

```{r percentile_class}
well_table_status(w_perc, perc_values, window) %>%
  select(` ` = class, everything()) %>%
  kable(format = "html", align = "lcccc") %>%
  bcgwl_style() %>%
  column_spec(1, background = c(perc_values$colour, "white"),
              color = c(perc_values$txt_colour, "black")) %>%
  footnote(symbol = note_values,
           symbol_manual = c("*")) %>%
  add_header_above(c("", "Current Year" = 2, "Last Year" = 2))
```

## Well summaries

```{r well_summaries_prep}
t <- well_table_summary(w_dates, w_hist, perc_values)
bg_colour <- t$bg_colour
txt_colour <- t$txt_colour
t <- select(t, -bg_colour, -txt_colour)

index <- table(t$region)
t <- select(t, -"region")
```

**Information on observation wells in `r year(t[["Latest\nDate"]][1])`**

```{r well_summaries}
t %>%
  kable(format = "html", escape = FALSE, align = "llllcccc") %>%
  bcgwl_style() %>%
  footnote(general = c(glue("Includes comparison of latest water depth value ",
                            "compared to last year's value"),
                       "Values/Medians are in meters below ground",
                       glue("n is the number of years included in ",
                            "the percentile calculation.")),
           symbol = "indicates Values with an Approval Status of 'Working'",
           symbol_manual = "*") %>%
  column_spec(str_which(names(t), "Percentile Class"), 
              background = bg_colour, color = txt_colour) %>%
  pack_rows(index = index)

```
  

## Plots

```{r plots, results = "asis", fig.asp = 0.9, fig.width = 10}
latest_date <- w_dates %>% 
  group_by(ow) %>% 
  filter(!is.na(Value)) %>%
  filter(Date == max(Date)) %>%
  filter(CurrentYear) #Keep only ones that are in Table 4?

for(ow in sort(ows)) {
  cat(glue("\n\n\n### {ow}\n\n\n"))
  full <- filter(w_full, ow == !!ow)
  hist <- filter(w_hist, ow == !!ow)
  date <- filter(latest_date, ow == !!ow)
  
  g1 <- well_plot_perc(full, hist, date, years_min)
  g2 <- well_plot_hist(full, hist)
  
  g <- g1 / g2
  print(g)
}
```


## Appendix A - Dates

If data isn't available for an exact reporting date, a date with data 
within a `r within * 2 + 1` day window around the reporting date is chosen instead.
If there are multiple dates with data, the dates are ranked based on their historical data 
quality (for calculating percentiles) and their nearness to the original date indicated.
The top date is then chosen for that well and that reporting date. 

This table lists the original reporting dates, and the actual dates used for each 
observation well. 

```{r appendix}
a <- appendix_dates(w_dates)
index <- table(a$region)

a %>%
  select(- "region") %>%
  kable(format = "html", digits = 2, escape = FALSE,
        caption = "Table A1") %>%
  bcgwl_style() %>%
  footnote(general = note_no_data) %>%
  add_header_above(c("", "", "", "Report Dates vs. Measurement dates" = 4)) %>%
  pack_rows(index = index)
```


## Appendix B - Calculations

### General details
- Water year starts in October
- Well measurements are all in Depth Below Ground in metres
- Current Water Year plots show data for the most recent water year with at least
  1 week of data (7 days).

### Percentiles
- Percentiles are calculated individually for each day of the year for each well
- 366 day in leap years is omitted
- "Good" quality data have 'Approved' historical values for >= `r years_min` years
- "Poor" quality data have 'Approved' historical values for < `r years_min` 
  years and are not used (percentiles for that well on that day of the year are
  missing from the figures and tables).


## Appendix C - Run info

**Date/Time:** `r Sys.time()`


### Parameters

- **Report Dates** (`report_dates`): `r glue_collapse(report_dates[1:2], ", ")`
- **Days in Window** (`within`): `r within`
  - Total window around (and including) a date is **`r within * 2 + 1` days**
- **Percentile Calculations**
  - **Min number of years** (`years_min`) - `r years_min`
  
### Session Info

**Platform**

```{r}
sessioninfo::platform_info()
```

**Packages**

```{r}
sessioninfo::package_info()
```

